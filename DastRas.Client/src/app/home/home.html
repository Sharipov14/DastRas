<!-- Transparent Glass Header -->
    <ion-header class="ion-no-border absolute top-0 left-0 z-50">
      <div class="px-5 pt-[calc(var(--ion-safe-area-top)+8px)] pb-3 flex items-center justify-between gap-4 bg-white/80 dark:bg-black/80 backdrop-blur-xl border-b border-white/20 dark:border-white/10">
        
        <!-- Address Selection -->
        <button (click)="goToAddresses()" class="flex flex-col items-start active:opacity-70 transition-opacity">
          <span class="text-[11px] text-gray-500 dark:text-gray-400 font-bold tracking-wide uppercase mb-0.5">Доставка</span>
          <div class="flex items-center gap-1.5">
             <span class="text-base font-extrabold text-gray-900 dark:text-white truncate max-w-[200px] leading-none">
               {{ currentAddress }}
             </span>
             <ion-icon name="chevron-down" class="text-xs text-[#ff6b35]"></ion-icon>
          </div>
        </button>

        <!-- Notification Button -->
        <button (click)="openNotifications()" class="w-10 h-10 rounded-full bg-black/5 dark:bg-white/10 flex items-center justify-center text-gray-900 dark:text-white active:scale-95 transition-transform backdrop-blur-sm relative">
           <ion-icon name="notifications" class="text-xl"></ion-icon>
           @if (notificationUnreadCount > 0) {
             <span class="absolute top-2.5 right-2.5 w-2 h-2 bg-red-500 rounded-full border border-white dark:border-black animate-pulse"></span>
           }
        </button>

      </div>
    </ion-header>

    <ion-content [fullscreen]="true" class="bg-gray-50 dark:bg-black">
      
      <!-- Spacer for Header + Tabs Padding -->
      <div class="pt-[calc(var(--ion-safe-area-top)+70px)] pb-24">
        
        <!-- Categories -->
        <div class="overflow-x-auto whitespace-nowrap px-5 py-2 no-scrollbar flex gap-3 mb-2">
          @for (cat of categories; track cat.id) {
            <button 
              class="px-5 py-2.5 rounded-full text-sm font-semibold transition-all duration-300 shadow-sm flex items-center gap-2"
              [ngClass]="selectedCategory === cat.id ? 'bg-[#ff6b35] text-white shadow-orange-500/30' : 'bg-white text-gray-600 dark:bg-[#1c1c1e] dark:text-gray-300'"
              (click)="selectCategory(cat.id)">
              <span class="text-lg leading-none"></span> {{ cat.name }}
            </button>
          }
        </div>

        <!-- Product Grid -->
        <div class="grid grid-cols-2 gap-4 px-5">
          @for (product of filteredProducts(); track product.id) {
            <div 
              class="bg-white dark:bg-[#1c1c1e] rounded-[2rem] p-3 shadow-[0_8px_30px_rgb(0,0,0,0.04)] dark:shadow-none flex flex-col h-full active:scale-[0.98] transition-all duration-200" 
              (click)="goToProduct(product.id)">
              
              <!-- Image -->
              <div class="relative w-full aspect-square rounded-[1.5rem] overflow-hidden bg-gray-100 dark:bg-gray-900 mb-3">
                <img [src]="product.imageUrl" class="w-full h-full object-cover" alt="{{ product.nameRu }}">
                
                <!-- Rating Badge -->
                <div class="absolute top-2.5 right-2.5 bg-white/80 dark:bg-black/60 backdrop-blur-md px-2 py-1 rounded-full text-[10px] font-bold flex items-center gap-1 shadow-sm dark:text-white">
                  <ion-icon name="star" class="text-yellow-400 text-xs"></ion-icon> {{ product.rating }}
                </div>
              </div>

              <div class="px-1 flex flex-col flex-1">
                <div class="mb-1">
                  <h3 class="font-bold text-gray-900 dark:text-white text-[15px] leading-tight line-clamp-2">{{ product.nameRu }}</h3>
                </div>
                <p class="text-xs text-gray-400 dark:text-gray-500 mb-3 font-medium">{{ product.unit }}</p>
                
                <div class="mt-auto flex items-center justify-between">
                  <span class="font-bold text-lg text-gray-900 dark:text-white">
                    {{ product.price }} <span class="text-[#ff6b35] text-sm">c.</span>
                  </span>
                  
                  @if (product.quantity === 0) {
                    <button 
                      class="w-9 h-9 rounded-full bg-gray-900 dark:bg-white text-white dark:text-black flex items-center justify-center active:scale-90 transition-transform shadow-lg shadow-gray-900/20"
                      (click)="$event.stopPropagation(); addToCart(product)">
                      <ion-icon name="add" class="text-xl"></ion-icon>
                    </button>
                  } @else {
                    <div class="flex items-center bg-[#ff6b35] rounded-full h-9 px-1 shadow-lg shadow-orange-500/30" (click)="$event.stopPropagation()">
                      <button 
                        class="w-8 h-full flex items-center justify-center text-white active:opacity-70"
                        (click)="updateQuantity(product, -1)">
                        <ion-icon [name]="product.quantity === 1 ? 'trash-outline' : 'remove'" class="text-lg"></ion-icon>
                      </button>
                      <span class="text-sm font-bold mx-0.5 min-w-[14px] text-center text-white">{{ product.quantity }}</span>
                      <button 
                        class="w-8 h-full flex items-center justify-center text-white active:opacity-70"
                        (click)="updateQuantity(product, 1)">
                        <ion-icon name="add" class="text-lg"></ion-icon>
                      </button>
                    </div>
                  }
                </div>
              </div>
            </div>
          }
        </div>

        <!-- Infinite Scroll Placeholder -->
        <ion-infinite-scroll (ionInfinite)="onIonInfinite($event)">
          <ion-infinite-scroll-content loading-spinner="crescent"></ion-infinite-scroll-content>
        </ion-infinite-scroll>
      </div>
    </ion-content>